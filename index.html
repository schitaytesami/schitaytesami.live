<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">

<head prefix="og: http://ogp.me/ns#">
	<title>Считайте Сами</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta property="og:title" content="Считайте Сами" />
	<meta property="og:url" content="https://schitaytesami.live" />
	<meta property="og:type" content="website" />
	<meta property="og:description" content="Проверяем явку на выборах, используя краудсорсинг и ускоренные видео" />
	<meta property="og:image" content="https://schitaytesami.live/images/logo.png" />
	<meta name="description" content="Проверяем явку на выборах, используя краудсорсинг и ускоренные видео" />
	<link href="https://schitaytesami.live/images/logo.png" rel="icon" type="image/png" />
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css" integrity="sha384-Smlep5jCw/wG7hdkwQ/Z5nLIefveQRIY9nfy6xoR1uRYBtpZgI6339F5dgvm/e9B"
	 crossorigin="anonymous">

	<style>
		.btn:focus, .btn:active {outline: none !important; box-shadow: none;}
		.toggle_clip_attribute.btn.active {outline: none !important; box-shadow: none !important; background-color: #5A6066 !important;}
		.instruction_video, .events_submit {position: absolute; top: 0; opacity: 0.9}

		html {
			overflow-y:scroll;
			position: relative;
			min-height: 100%;
		}

		body {
			display: flex;
			flex-direction: column;
			height: 100%;
			height: 100vh;
		}

		nav {
			flex-shrink: 0;
		}

		main {
			flex-grow: 1;
		}

		.text-decoration-underline {
			text-decoration: underline;
		}

		.instr-screenshot {
			max-width: 49%;
		}
		.navbar-brand {
			padding: 0;
			line-height: 2.4rem;
		}
		.nav-link {
			padding: 0;
			line-height: 2.4rem;
		}
		.navbar {
			padding: 0 1rem;
		}
		.navbar .nav-link {
			border-radius: unset;
		}
		.login_link .bg-success {
			background-color: #C2EABD !important;
		}

		.thumbnail {
			display: inline-block;
			width: 120px; /* 640 */
			height: 90px; /* 480 */
			padding: 2px;
		}

		.payment-form__currency {
			position: relative;
		}

		.payment-form__currency::after {
			content: '\20BD';
			position: absolute;
			right: 8px;
			top: 3px;
			color: #999;
		}

		.payment-form input[type=radio] {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			opacity: 0;
			cursor: pointer;
		}

		.payment-form input[type=radio]:checked + label {
			background-color: #ffeca6;
		}

		.payment-form__radios {
			display: flex;
			align-items: flex-end;
			justify-content: center;
			height: 100%;
		}

		.payment-form__radio {
			position: relative;
			border: 1px solid lightgray;
			border-right-width: 0;
		}

		.payment-form__radio:first-child {
			border-top-left-radius: 3px;
			border-bottom-left-radius: 3px;
		}

		.payment-form__radio:last-child {
			border-right-width: 1px;
			border-top-right-radius: 3px;
			border-bottom-right-radius: 3px;
		}

		.payment-form__label {
			display: inline-block;
			margin: 0;
			padding: 0 1em 0.3em;
			cursor: pointer;
		}

		.icon {
			display: inline-block;
			position: relative;
			vertical-align: middle;
			background-size: contain;
			background-position: 50%;
			background-repeat: no-repeat;
		}

		.icon.pc {
			width: 16px;
			height: 21px;
			background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMTYiIGhlaWdodD0iMjEiIHZpZXdCb3g9IjAgMCAxNiAyMSI+PGRlZnM+PHBhdGggaWQ9ImEiIGQ9Ik0wIC4wNjFoMTUuODg0djIwLjUzNUgweiIvPjwvZGVmcz48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxtYXNrIGlkPSJiIiBmaWxsPSIjZmZmIj48dXNlIHhsaW5rOmhyZWY9IiNhIi8+PC9tYXNrPjxwYXRoIGZpbGw9IiNGRkNGMDAiIGQ9Ik0wIDEwLjI0N2MwLTEuMTU0LjEtMS44ODUgMi41MjctMy42NjhDNC41MzcgNS4xMDQgMTAuOTgzLjA2MSAxMC45ODMuMDYxdjguNDJoNC45djEyLjExNkgxLjUzMmMtLjg0MiAwLTEuNTMtLjY4LTEuNTMtMS41MDZ2LTguODQ0eiIgbWFzaz0idXJsKCNiKSIvPjxwYXRoIGZpbGw9IiNEN0IwMDAiIGQ9Ik0xMS40OTEgOHY0LjkxOEwyIDE5bDEyLTMuNjczVjh6Ii8+PHBhdGggZmlsbD0iIzFEMUQxQiIgZD0iTTYuNTYxIDguNzYyYy42NDctLjcyIDEuNTktLjk3NSAyLjExLS41NjguNTE4LjQwNy40MTMgMS4zMjItLjIzMyAyLjA0My0uNjQ2LjcyMi0xLjU5Ljk3Ni0yLjEwOC41NjktLjUxOC0uNDA4LS40MTUtMS4zMjMuMjMxLTIuMDQ0Ii8+PC9nPjwvc3ZnPgo=")
			/*background-image: url(https://money.yandex.ru/b/_/sqJ2MGna3IZGNFXC9k4QOrzUG-c.svg);*/
		}

		.icon.ac {
			width: 19px;
			height: 20px;
			background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMyIgaGVpZ2h0PSIyMyIgdmlld0JveD0iMCAwIDIzIDIzIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0wLTJoMjNWOUgweiIgb3BhY2l0eT0iLjQ4MSIvPjxwYXRoIGZpbGw9IiMyQzc5QkUiIGQ9Ik04IDdsMS4xNTQtN0gxMUw5Ljg0NiA3SDhtOS02LjcxNUE1LjU3IDUuNTcgMCAwIDAgMTUuMjA4IDBjLTEuOTc3IDAtMy4zNjguOTItMy4zOCAyLjIzOC0uMDEyLjk3NS45OTMgMS41MTggMS43NTEgMS44NDIuNzguMzMzIDEuMDQxLjU0NSAxLjAzOC44NDItLjAwNS40NTQtLjYyMi42NjItMS4xOTcuNjYyLS44IDAtMS4yMjUtLjEwMi0xLjg4My0uMzU1bC0uMjU3LS4xMDhMMTEgNi42MzljLjQ2Ni4xODkgMS4zMy4zNTMgMi4yMjguMzYxIDIuMTAxIDAgMy40NjYtLjkxIDMuNDgyLTIuMzE2LjAwNy0uNzczLS41MjYtMS4zNTktMS42OC0xLjg0My0uNjk4LS4zMTQtMS4xMjctLjUyMy0xLjEyMi0uODQgMC0uMjgzLjM2Mi0uNTg0IDEuMTQ2LS41ODRhMy45NDIgMy45NDIgMCAwIDEgMS40OTYuMjZsLjE4LjA3OC4yNy0xLjQ3TTIxLjY0OCAwaC0xLjI5MWMtLjQgMC0uNy4xMjQtLjg3Ni41OEwxNyA3aDEuNzU1cy4yODYtLjg2My4zNTEtMS4wNTNsMi4xNC4wMDRjLjA1LjI0NC4yMDMgMS4wNDkuMjAzIDEuMDQ5SDIzbC0xLjM1Mi03bS0yLjA2MSA0LjUxNGMuMTM4LS40MDMuNjY1LTEuOTU4LjY2NS0xLjk1OC0uMDEuMDE5LjEzOC0uNDA2LjIyMi0uNjY4bC4xMTMuNjA0LjM4NyAyLjAyMmgtMS4zODdNMS44MzguOTE0QTYuOTg2IDYuOTg2IDAgMCAwIDAgLjE0NUwuMDIzIDBoMi44MjFjLjM4LjAxNi42ODguMTQ3Ljc5My41OTFsLjYxMyAzLjIyLjE4NC45NzFMNi4xNDYuMDA1SDhMNS4yNDUgNi45OTkgMy4zOTQgNyAxLjgzOC45MTR6Ii8+PHBhdGggZmlsbD0iI0ZGNUYwMCIgZD0iTTkgMjJoNXYtOUg5eiIvPjxwYXRoIGZpbGw9IiNFQjAwMUIiIGQ9Ik05Ljg3NSAxNy41YzAtMS43NTUuODMxLTMuMzE3IDIuMTI1LTQuMzI0QTUuNTc4IDUuNTc4IDAgMCAwIDguNTYyIDEyQzUuNDkgMTIgMyAxNC40NjIgMyAxNy41UzUuNDkgMjMgOC41NjIgMjNjMS4yOTggMCAyLjQ5Mi0uNDQgMy40MzgtMS4xNzZBNS40NjkgNS40NjkgMCAwIDEgOS44NzUgMTcuNSIvPjxwYXRoIGZpbGw9IiNGNzlFMUIiIGQ9Ik0yMSAxNy41YzAgMy4wMzgtMi40OSA1LjUtNS41NjIgNS41QTUuNTc4IDUuNTc4IDAgMCAxIDEyIDIxLjgyNGE1LjQ2OSA1LjQ2OSAwIDAgMCAyLjEyNS00LjMyNEE1LjQ2NyA1LjQ2NyAwIDAgMCAxMiAxMy4xNzYgNS41NzggNS41NzggMCAwIDEgMTUuNDM4IDEyQzE4LjUxIDEyIDIxIDE0LjQ2MiAyMSAxNy41Ii8+PC9nPjwvc3ZnPgo=")
			/*background-image: url(https://money.yandex.ru/b/_/znDCcGN9U__lRVsmiQ6akvmMXuE.svg);*/
		}
	</style>
</head>

<body id="tabparent">

	<div id="app"></div>

	<script type="text/x-template" id="app-navigation-menu">
		<header>
			<nav class="bg-dark">
				<div class="navbar justify-content-start flex-nowrap">
					<ul class="nav nav-pills w-100 navbar-dark">
						<li class="nav-pill"><router-link class="navbar-brand" :to="{ name: 'index' }">Считайте Сами</router-link></li>
						<li class="nav-pill navbar-nav"><router-link class="nav-link px-2" :to="{ name: 'task' }">Участвовать</router-link></li>
						<li class="nav-pill navbar-nav"><router-link class="nav-link px-2" :to="{ name: 'stations' }">Результаты</router-link></li>
						<li class="nav-pill navbar-nav"><router-link class="nav-link px-2" :to="{ name: 'users' }">Рейтинг участников</router-link></li>
						<li class="nav-pill navbar-nav"><router-link class="nav-link px-2" :to="{ name: 'about' }">О проекте</router-link></li>
						<li class="nav-pill navbar-nav">
							<router-link class="nav-link px-2" :to="{ name: 'donate' }">
								<abbr title="Техника дорогая!" style="border-bottom: 4px dotted">Помочь деньгами</abbr>
							</router-link>
						</li>
						<template v-if="this.$root.user">
							<li class="nav-pill navbar-nav ml-auto">
								<router-link
									class="nav-link px-2"
									:to="{ name: 'user', params: { display: this.$root.user.display } }"
								>{{ this.$root.user.display }}</router-link>
							</li>
							<li class="ml-1">
								<button
									type="button"
									class="btn btn-link text-warning"
									@click="logout"
								>[выход]</button>
							</li>
						</template>
					</ul>
				</div>
			</nav>
		</header>
	</script>

	<script type="text/x-template" id="app-index">
		<div class="row">
			<div class="col-md-6 offset-md-3">
				<blockquote class="mb-0">
					<p>Здесь Вы можете сами поучаствовать в определениии реальной явки и контроле процедуры подсчёта голосов на прошедших выборах. Выявленное расхождения в явке — верный признак фальсификации итогов голосования, которая является уголовным преступлением. Нарушения при подсчете голосов могут производиться для маскировки фальсификаций, за них предусмотрена административная ответсвенность.</p>
					<p>Ваша помощь будет заключаться в просмотре фрагментов видео и заполнении кратких отчетов на нашем сайте. По результатам ваших отчетов наши юристы будут направлять заявления в следственный комитет или в прокуратуру.</p>
					<p>Следите за нашими новостями в <a href="https://twitter.com/schitaytesami">Твиттере</a> или <router-link :to="{ name: 'about' }">свяжитесь с нами</router-link>.</p>
				</blockquote>
				<ul class="bg-light">
					<li>Зарегистрировано: <span v-if="guard"><span>{{ $root.stats.users.length }}</span> пользователей</span><span v-else>загрузка...</span></li>
					<li>Всего видео в системе: <span v-if="guard"><span>{{ $root.stats.stations.length }}</span> избирательных участков (<span>{{ formatHours($root.stats.num_seconds) }}</span> часов)</span><span v-else>загрузка...</span></li>
					<li>Полностью размечено: <span v-if="guard"><span>{{ $root.stats.num_stations_labeled }}</span> избирательных участков (<span>{{ formatHours($root.stats.num_seconds_labeled) }}</span> часов)</span><span v-else>загрузка...</span></li>
				</ul>
				<router-link :to="{ name: 'task' }" class="btn btn-primary mb-2 mt-2 w-100"><h3>Начать работу</h3></router-link>
				<div v-if="guard">
					<img class="thumbnail" width="120" height="80" :src="clip_station.clip.thumbnail" :title="formatThumbnailTitle(clip_station.station, clip_station.clip)" :key="i" v-for="(clip_station, i) in thumbnails" />
				</div>
			</div>
		</div>
	</script>

	<script type="text/x-template" id="app-task">
		<div class="row">
			<div class="col-md-6 offset-md-3">
				<div class="mb-3" :class="{ 'bg-warning': !registered, 'bg-success': registered }" v-if="!$root.user">
					<template v-if="!registered">
						<h1 class="lead text-center">Для начала работы введите адрес эл. почты и зарегистрируйтесь</h1>
						<div class="container">
							<div class="row pl-2 pr-2">
								<div class="form-group col pl-0">
									<input type="text" class="form-control user_email" v-model="email" placeholder="Эл. почта" />
								</div>
								<div class="ml-auto">
									<button class="btn btn-primary" @click.prevent="register">Зарегистрироваться</button>
								</div>
							</div>
						</div>
					</template>
					<p class="text-center text-light" v-else>Успех! Ссылка-приглашение отправлена на вашу электронную почту, проверьте ваш почтовый ящик и папку "Спам"! Переходите по этой ссылке для входа в систему.</p>
				</div>

				<h3 class="text-center lead">Подсчёт явки</h3>
				<p>Мы предложим вам короткие <strong>3-4-минутные</strong> фрагменты ускоренного видео с избирательных участков. После изучения подробной инструкции нужно будет отмечать моменты, когда избиратель опускает бюллетень в избирательную урну.</p>
				<template v-if="$root.user">
					<app-selection
						:options="$root.stats.task_selector_options"
						v-if="$root.stats.task_selector_options"
					>
					<router-link
						class="btn btn-primary mb-2 mt-2 w-100"
						slot-scope="{ election_number, region_number, station_number }"
						:to="{ name: 'vote', params: { election_number, region_number, station_number }}"
						><h5 class="mb-0">Начать работу</h5></router-link>
					</app-selection>
				</template>
				<h3 class="text-center lead mt-2">Проверка процедур подсчёта голосов</h3>
				<p>Это задание более близко к реальному наблюдению на участке и требует изучения процедуры подсчёта голосов избирательной комиссии, изложенной в нашей инструкции. Мы попросим вас просмотреть <strong>3-4-часовые</strong> фрагменты и отметить, как избирательная комиссия выполнила требования закона о выборах.</p>
				<template v-if="$root.user">
					<app-selection
						:options="$root.stats.task_selector_options"
						v-if="$root.stats.task_selector_options"
					>
					<router-link
						class="btn btn-primary mb-2 mt-2 w-100"
						slot-scope="{ election_number, region_number, station_number }"
						:to="{ name: 'proc', params: { election_number, region_number, station_number }}"
						><h5 class="mb-0">Начать работу</h5></router-link>
					</app-selection>
				</template>
			</div>
		</div>
	</script>

	<script type="text/x-template" id="app-task-base">
		<div>
			<div class="row instruction" v-if="showInstruction">
				<div class="col-md-6 offset-md-3">
					<div>
						<p>Эффективность проекта зависит от вашей аккуратности, пожалуйста, отнеситесь к отметкам ответственно. В данном случае полностью применим принцип «лучше меньше да лучше». Пожалуйста, внимательно прочитайте эту инструкцию. В случае возникновения вопросов напишите нам письмо на <code>schitaytesami@gmail.com</code>. Мы постараемся ответить оперативно.</p>
						<p>Ваша цель – определить число опустивших бюллетени в ящики для голосования, в показываемом Вам фрагменте видео. Считать в уме ничего не придется, но придется внимательно, не отвлекаясь, просматривать видео.</p>
					</div>
					<slot name="instruction"></slot>
				</div>
			</div>

			<div class="row mt-3">
				<div class="col-md-5">
					<app-clip-player
						:verbose="false"
						:clip="clip"
						:started.sync="started"
						:completed.sync="completed"
						ref="player"
						v-if="clip"
					>
						<div
							class="instruction_video w-100 text-center bg-light"
							slot="intro"
							v-if="!started"
						>
							<p>Средняя продолжительность видео приблизительно 3-4 минуты.</p>
							<p>Пожалуйста, сделайте работу до конца. <strong>Спасибо!</strong></p>
						</div>

						<div
							class="events_submit w-100 h-100 text-center bg-light"
							slot="end"
							v-if="completed"
						>
							<div class="h-100 d-flex flex-column justify-content-center">
								<h2>{{ formatTaskSubmitResultsButtonText(submitted, failed).message }}</h2>
								<div><button class="btn btn-success" :class="{ 'btn-danger': failed }" @click.prevent="submitResults">{{ formatTaskSubmitResultsButtonText(submitted, failed).button }}</button></div>
							</div>
						</div>

					</app-clip-player>

					<div v-if="clip">
						<button
							class="btn btn-sm btn-block d-flex align-items-center justify-content-between pr-0"
							@click="showEvents = !showEvents"
						>
							<h3 class="m-0 text-left text-decoration-underline">ОТМЕТКИ</h3>
							<span>&#9660;</span>
							<h2 class="m-0 w-25 text-right">{{ events.length }}</h2>
						</button>
						<table class="table table-sm table-striped mt-2">
							<tbody v-if="showEvents">
								<tr v-for="event in events">
									<td class="text-left">{{ formatEventTime(event.offset) }}</td>
									<td class="text-left text-truncate">{{ event.value ? event.value : '+1 голос' }}</td>
									<td class="text-right pr-0">
										<a href="#/task/vote" class="btn text-danger p-0" title="Удалить" @click.prevent="removeEvent(event)">❌</a>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>

				<div class="col-md-7">
					<div class="btn-group w-100 mb-4" role="group">
						<button
							type="button"
							class="btn btn-info flex-grow-1"
							@click="showInstruction = !showInstruction"
						>{{ formatInstructionToggleText(showInstruction) }}</button>
						<app-bookmark-button :clip="clip" class="flex-grow-1"/>
					</div>

					<template v-if="are_controls_vote_shown">
						<div class="btn-group-vertical w-100 mb-3">
							<div class="btn-group">
								<input
									type="text"
									class="form-control"
									placeholder="Необычное? Опишите здесь!"
									v-model.trim="note"
									ref="note" />
								<button
									type="button"
									class="btn btn-primary w-50 add_note"
									@click.prevent="addEvent($refs.player.currentTime, 'note', note)"
								>Добавить</button>
							</div>
							<div class="btn-group mt-2">
								<button
									type="button"
									class="btn btn-success w-100"
									@click="addEvent($refs.player.currentTime, 'vote')"
								>+1 голос (на клавиатуре <kbd>пробел</kbd>)</button>
							</div>
						</div>
					</template>

					<template class="mt-2" v-if="are_controls_proc_shown">
						<button
							class="btn btn-success w-100 mb-2"
							:class="{ 'btn-danger': failed }"
							@click.prevent="submitResults"
							v-if="false"
						>{{ formatTaskSubmitResultsButtonText(submitted, failed).button }}</button>
						<h6 class="lead">Контроль процедуры подсчёта голосов</h6>
						<ul class="list-group">
							<li class="list-group-item" v-for="(question, idx) in questions" >
								<p class="mb-1">
									<strong>{{1 + idx }}</strong>.
									<span v-html="question.question_text"></span>
								</p>

								<div class="form-check form-check-inline bg-secondary text-white mr-0 p-1" v-if="!question.hide_yes_no">
									<input :id="'cannot' + idx" class="form-check-input" type="radio" :name="idx" checked v-model="question.yes_no">
									<label :for="'cannot' + idx" class="form-check-label">Не могу ответить</label>
								</div>
								<div class="form-check form-check-inline bg-success text-white mr-0 p-1" v-if="!question.hide_yes_no">
									<input :id="'yes' + idx" class="form-check-input" type="radio" :name="idx" value="yes" v-model="question.yes_no">
									<label :for="'yes' + idx" class="form-check-label">Да</label>
								</div>
								<div class="form-check form-check-inline bg-danger text-white mr-0 mb-1 p-1" v-if="!question.hide_yes_no">
									<input :id="'no' + idx" class="form-check-input" type="radio" :name="idx" value="no" v-model="question.yes_no">
									<label :for="'no' + idx" class="form-check-label">Нет</label>
								</div>
								<div class="form-check-form-check-inline">
									<input
										class="w-100"
										type="text"
										placeholder="Введите в это поле время нарушения или комментарий" v-model="question.comment" />
								</div>
							</li>
						</ul>
					</template>
				</div>
			</div>
		</div>
	</script>

	<script type="text/x-template" id="app-task-vote">
		<div>
			<app-task-base
				:are_controls_vote_shown="true"
				:are_controls_proc_shown="false"
			>
				<dl slot="instruction">
					<dt>Опускание бюллетеня</dt>
					<dd>Каждый раз, когда подошедший к урне избиратель опускает в урну свой первый бюллетень, Вам необходимо или кликнуть на <button href="#" class="btn btn-success btn-sm">зелёную кнопку</button> под окном видео, или нажать на пробел (строго одно из двух). Пожалуйста, старайтесь не допускать слишком большого запаздывания (запаздывание в 1-2 секунды допустимо). Не нажимайте на кнопку/пробел заранее, дождитесь момента, когда бюллетень опустится в прорезь ящика для голосования.</dd>

					<dd><i>В случае, когда подошедший к урне избиратель опускает в урну два и более бюллетеней, Вам необходимо реагировать только на первое опускание бюллетеня (опускание нескольких бюллетеней всего скорее связано с совмещением выборов разных уровней). Исключение составляет случай, когда несколько людей (например, семейная пара) подходят к урне вместе, и один человек опускает бюллетени за всех.	В этом случае реагируйте на опускание двух или более бюллетеней (по числу людей подошедших вместе).</i></dd>

					<dt>Пауза в работе</dt>
					<dd>Вы можете приостановить видео, кликнув по нему в центре или нажав <kbd>escape</kbd> на клавиатуре. Возобновить работу можно, снова кликнув по видео в центре.</dd>

					<dt>Исправление ошибок</dt>
					<dd>Вы можете удалить ошибочные отметки из списка вручную, нажав на красный крест <a class="text-danger">❌</a>.</dd>

					<dt>Нештатные ситуации</dt>
					<dd>При наблюдении любой нештатной ситуации, на которую Вы хотели бы обратить наше внимание, введите краткое описание ситуации и нажмите на <button href="#" class="btn btn-primary btn-sm">синюю кнопку</button>. Таким же образом нужно дать нам знать об ошибках системы (например о систематической ускоренной перемотке через момент опускания бюллетеня).</dd>

					<dt>Досрочное окончание работы</dt>
					<dd>Фрагменты видео, не досмотренные до конца, не учитываются и не участвуют в дальнейшей обработке.</dd>
				</dl>
			</app-task-base>
		</div>
	</script>

	<script type="text/x-template" id="app-task-proc">
		<div>
			<app-task-base
				:are_controls_vote_shown="false"
				:are_controls_proc_shown="true"
			>
				<ol slot="instruction">
					<li>Перед просмотром внимательно прочитайте Анкету (она представляет собой отчет, который будет затем автоматически обрабатываться). Анкета содержит вопросы о выполнении процедур, которые прописаны в законе. При чтении Анкеты вы должны определить, понятен ли вам вопрос. Вопросы составлены так, что положительный ответ на вопрос – это и есть требование закона.</li>
					<li>Перед просмотром заполните верхнюю часть Анкеты.</li>
					<li>Ответы в анкету можно вписывать как во время просмотра (с приостановкой просмотра!), так и после просмотра. <br />Ответы можно давать в любой последовательности, но последовательность вопросов соответствует предусмотренной законом последовательности подсчета голосов.</li>
					<li>Ответы вы даёте путем нажатия на одну из кнопок «Да», «Нет», «Не могу ответить». Вы должны нажать на одну из кнопок обязательно. Положительный ответ означает то, что предусмотренная законом процедура, в основном, была выполнена. <br/>Ответ «Нет» давайте только в том случае, если нарушение очевидно. Сомнения должны трактоваться в пользу УИК.</li>
					<li>Вы можете написать комментарий к любому вопросу Анкеты. Если ответ на вопрос отрицательный, то впишите в поле «Комментарий» примерный интервал времени (по показаниям в левом верхнем углу видеозаписи) времени, когда было допущено нарушение. Другие записи в поле «Комментарий» также допустимы.</li>
					<li>Ответы на вопросы 12 и 13 относятся не к процедурам подсчета, а к качеству видеозаписи. </li>
					<li>14-я строка Анкеты заполняется текстом в произвольной форме по желанию исследователя. (например, Вы заметили вброс бюллетеней перед или во время сортировки бюллетеней). При этом обязательно указывается время нарушения.</li>
				</ol>
			</app-task-base>
		</div>
	</script>

	<script type="text/x-template" id="app-notes">
		<table class="table table-sm">
			<thead>
				<tr>
					<th>Дата голосования</th>
					<th>Регион</th>
					<th>УИК</th>
					<th>Комментарий</th>
				</tr>
			</thead>
			<tbody>
				<tr v-for="note in notes.sort(sorter)">
					<td>{{ formatElectionDate(note.election_number) }}</td>
					<td>{{ formatRegionName(note.station_address) }}</td>
					<td><router-link :to="{name: 'station', params: { id: $root.stats.formatStationIdFull(note.station_id) } }">{{ note.station_number }}</router-link></td>
					<td class="w-50" :title="'Добавлено ' + formatTimestamp(note.timestamp)">{{ note.value }}</td>
				</tr>
			</tbody>
		</table>
	</script>

	<script type="text/x-template" id="app-stations">
		<div class="row">
			<div class="col-md-12">
				<table class="table table-striped mt-2">
					<thead>
						<tr>
							<th>Дата голосования</th>
							<th>Регион</th>
							<th>УИК</th>
							<th>Явка, официальная</th>
							<th style="border-right: 2px solid black">Явка, видеоподсчет</th>
							<th class="text-muted">Прогресс</th>
							<th class="text-muted">Комментарии</th>
						</tr>
					</thead>
					<tbody>
						<tr v-for="station in $root.stats.stations" :key="station.id">
							<td>{{ formatElectionDate(station.election_number) }}</td>
							<td>{{ formatRegionName(station.station_address) }}</td>
							<td><router-link :to="{name: 'station', params: { id: station.station_id } }">{{ station.station_number }}</router-link></td>
							<td>{{ station.turnout.official.final }}</td>
							<td style="border-right: 2px solid black">{{ station.turnout.estimate.final }}</td>
							<td class="text-muted">{{ formatPercent(station.turnout.progress) }}</td>
							<td class="text-muted text-truncate">{{ station.turnout.comment }}</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</script>

	<script type="text/x-template" id="app-station">
		<div class="row" id="station">
			<div class="col-md-6 offset-md-3">
				<app-clip-player :clip="current_clip" :verbose="true" v-if="current_clip" />
			</div>
			<div class="col-md-12">
				<div>
					<h3 class="text-center lead">Явка по официальным интервалам</h3>
					<table class="table-bordered table-striped w-100 mb-3">
						<tbody>
							<tr>
								<th></th><th>Окончательная</th><th>8:00-10:00</th><th>10:00-12:00</th><th>12:00-15:00</th><th>15:00-18:00</th>
							</tr>
							<tr>
								<th>Явка, официальная</th>
								<td v-for="d in getTurnout('official')">{{ d }}</td>
							</tr>
							<tr>
								<th>Явка, видеоподсчет</th>
								<td v-for="d in getTurnout('estimate')">{{ d }}</td>
							</tr>
						</tbody>
					</table>

					<h3 class="text-center lead">Явка по ускоренным сегментам</h3>
					<figure>
						<div class="row no-gutters">
							<div class="col" v-for="segment in segments">
								<table class="table table-sm table-bordered table-striped w-100">
									<thead>
										<tr><th scope="col">Интервал</th><th>Явка, видеоподсчет</th></tr>
									</thead>
									<tbody>
										<tr v-for="(clip, i) in segment" :key="i">
											<td>
												<button class="btn btn-link btn-sm w-100 p-0 text-left" type="button" @click="current_clip = clip">{{ formatClipInterval(clip, station) }}</button>
											</td>
											<td :class="{ 'text-muted': !clip.turnout.estimate && clip.turnout.average }"
												>{{ clip.turnout.estimate || (clip.turnout.average && (clip.turnout.average + '*')) || '' }}</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
						<figcaption>
							<p class="text-muted text-right">* предварительный результат</p>
						</figcaption>
					</figure>

					<div class="row no-gutters mt-3">
						<div class="col">
							<h3 class="text-center lead">Комментарии</h3>
							<app-notes :notes="notes" v-if="notes.length > 0" />
							<h6 class="text-center" v-if="notes.length == 0">Нет открытых комментариев.</h6>
						</div>
					</div>

					<div class="mt-3" v-if="$root.user">
						<h3 class="text-center lead">Дополнительно</h3>
						<div class="row no-gutters mb-2">
							<div class="col text-center">
								<app-access-button :station_id="station.id" :user_id="$root.user.id" />
							</div>
						</div>
						<div
							class="row no-gutters mb-2"
							v-if="$root.checkStationAccess(station.id) === 1"
						>
							<div class="col text-center">
								<table class="table table-sm table-bordered table-striped w-100">
									<thead>
										<tr>
											<th>Тип задания</th>
											<th v-for="(camera_id, i) in tasks.camera_ids" :title="camera_id">Интервал (камера #{{ i + 1 }})</th>
										</tr>
									</thead>
									<template v-for="t in tasks.tasks">
										<tr v-for="(_, i) in Array(t.max_num_clips).fill()">
											<td>{{ formatClipTask(t.task) }}</td>
											<td v-for="camera_id in tasks.camera_ids">
												<button
													type="button"
													class="btn btn-link btn-sm w-100 p-0"
													@click="current_clip = t.clips[camera_id][i]"
													>{{ formatClipInterval(t.clips[camera_id][i], station) }}</button>
												</button>
											</td>
										</tr>
									</template>
								</table>
							</div>
						</div>
					</div>

				</div>
			</div>
		</div>
	</script>

	<script type="text/x-template" id="app-clip-player">
		<div>
			<h3 :title="station.station_address">
				<router-link :to="{name: 'station', params: { id: $root.stats.formatStationIdFull(station.id) } }">УИК {{ station.station_number }}</router-link>
				<span class="float-right">{{ formatClipInterval(clip, station, true) }}</span>
			</h3>
			<h6><span
				>{{ verbose ? station.station_address : formatRegionName(station.station_address) }}</span><span
					class="float-right"
					v-if="verbose"
				>UTC+<span
					>{{ formatTimezoneOffset(station.timezone_offset) }}</span>
				</span>
			</h6>

			<div class="position-relative">
				<video
					class="app-station__video--js w-100"
					controls="controls"
					preload="auto"
					ref="player"
					:src="clip.video"
					@timeupdate="currentTime = $event.target.currentTime"
					@play.once="$emit('update:started', true)"
					@ended="$emit('update:completed', true)"
				></video>

				<slot name="intro"></slot>
				<slot name="end"></slot>
			</div>


			<div class="btn-group btn-group-sm">
				<div class="d-inline-flex align-items-center pr-1 bg-light">
					<span class="font-weight-bold">Скорость {{ playbackRate.toFixed(1) }}x</span>
				</div>
				<button
					type="button"
					class="btn btn-secondary"
					@click.prevent="setPlaybackRate(-0.5)"
				>Медленнее</button>
				<button
					type="button"
					class="btn btn-secondary"
					@click.prevent="setPlaybackRate(+0.5)"
				>Быстрее</button>
			</div>

		</div>
	</script>

	<script type="text/x-template" id="app-users">
		<div class="row">
			<div class="col-md-12">
				<table class="table table-striped mt-2">
					<thead>
						<tr>
							<th class="text-muted">#</th>
							<th>Имя</th>
							<th>Избиратели</th>
							<th>Участки</th>
							<th>Просмотрено минут</th>
							<th>Сегменты</th>
							<th>Комментарии</th>
						</tr>
					</thead>
					<tbody>
						<tr
							v-for="(user, index) in $root.stats.users"
							:key="user.id"
							:class="{ 'bg-success': $root.user && $root.user.id === user.id }"
						>
							<td class="text-muted">{{ index + 1 }}</td>
							<td>
								<router-link :to="{ name: 'user', params: { display: user.display } }">{{ user.display }}</router-link>
							</td>
							<td>{{ user.num_votes }}</td>
							<td>{{ user.num_stations }}</td>
							<td>{{ formatMinutes(user.num_seconds) }}</td>
							<td>{{ user.num_clips }}</td>
							<td>{{ user.num_notes }}</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</script>

	<script type="text/x-template" id="app-user">
		<div v-if="!this.$root.showError">
			<div class="row mb-2 justify-content-center">
				<div class="col-12">
					<h4 class="text-center lead">{{ user.display }}</h4>
				</div>

				<div class="col-lg-4">
					<table class="table table-sm table-borderless">
						<tbody>
							<tr>
								<th scope="row">Избиратели</th>
								<td>{{ user.num_votes }}</td>
							</tr>
							<tr>
								<th scope="row">Участки</th>
								<td>{{ user.num_stations }}</td>
							</tr>
							<tr>
								<th scope="row">Просмотрено минут</th>
								<td>{{ user.num_seconds !== undefined ? (user.num_seconds / 60).toFixed(0) : '' }}</td>
							</tr>
							<tr>
								<th scope="row">Сегменты</th>
								<td>{{ user.num_clips }}</td>
							</tr>
							<tr>
								<th scope="row">Комментарии</th>
								<td>{{ user.num_notes }}</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>

			<template v-if="$root.user && $route.params.display === $root.user.display">
				<div class="row mb-2 justify-content-center">
					<div class="col-lg-12">
						<h5 class="text-center">Закладки</h5>
						<table class="table table-sm" v-if="bookmarks.length > 0">
							<thead>
								<th scope="col">Дата голосования</th>
								<th scope="col">Регион</th>
								<th scope="col">УИК</th>
								<th scope="col">Ссылка</th>
							</thead>
							<tbody>
								<tr v-for="bookmark in bookmarks">
									<td>{{ formatElectionDate(bookmark.election_number) }}</td>
									<td>{{ formatRegionName(bookmark.station_address) }}</td>
									<td>
										<router-link :to="{ name: 'station', params: { id: $root.stats.formatStationIdFull(bookmark.station_id) }}">
											{{ bookmark.station_number }}
										</router-link>
									</td>
									<td class="w-50">
										<a :title="'Добавлено ' + formatTimestamp(bookmark.timestamp)" :href="bookmark.value">Перейти</a>
									</td>
								</tr>
	 						</tbody>
						</table>
						<h6 class="text-center" v-if="bookmarks.length == 0">Вы ещё не добавили закладки.</h6>
					</div>
				</div>

				<div class="row mb-2 justify-content-center">
					<div class="col-lg-12">
						<h5 class="text-center">Комментарии</h5>
						<app-notes :notes="notes" v-if="notes.length > 0" />
						<h6 class="text-center" v-if="notes.length == 0">Вы ещё не добавили комментариев.</h6>
					</div>
				</div>

				<div class="row mb-2 justify-content-center">
					<div class="col-lg-12">
						<h5 class="text-center">Доступ</h5>
						<table class="table table-sm" v-if="station_access.length > 0">
							<thead>
								<th scope="col">Дата голосования</th>
								<th scope="col">Регион</th>
								<th scope="col">УИК</th>
								<th scope="col">Статус</th>
							</thead>
							<tbody>
								<tr v-for="sa in station_access">
									<td>{{ formatElectionDate(sa.election_number) }}</td>
									<td>{{ formatRegionName(sa.station_address) }}</td>
									<td>
										<router-link :to="{ name: 'station', params: { id: $root.stats.formatStationIdFull(sa.id) }}">
											{{ sa.station_number }}
										</router-link>
									</td>
									<td class="w-50">
										<app-access-button
											:title="formatTimestamp(sa.timestamp)"
											:station_id="sa.id"
											:user_id="user.id"/>
									</td>
								</tr>
							</tbody>
						</table>
						<h6 class="text-center" v-if="station_access.length == 0">Вы ещё не запрашивали полный доступ к видео.</h6>
					</div>
				</div>
			</template>


			<div class="row">
				<div class="col">
					<div>
						<router-link :to="{name: 'station', params: { id: thumb.id } }" v-for="thumb in thumbnails">
							<img class="img-thumbnail thumbnail" width="120" height="90" :src="thumb.src" :title="thumb.title" :key="thumb.id" />
						</router-link>
					</div>
				</div>
			</div>
		</div>
	</script>

	<script type="text/x-template" id="app-about">
		<div class="row">
			<div class="col-md-6 offset-md-3">
				<dl id="about">
					<dt>Контакты</dt>
					<dd>
						Электронная почта: <code>schitaytesami@gmail.com</code><br />
						Twitter: <a href="https://twitter.com/schitaytesami">https://twitter.com/schitaytesami</a><br />
						GitHub: <a href="https://github.com/schitaytesami">https://github.com/schitaytesami</a>

						<p><br />Подробности, комментарии экспертов, эксклюзивную и достоверную информацию из первых рук можно получить по указанным выше контактам.</p>
						<p><mark>Для получения полных неофициальных видео пришлите письмо на <code>schitaytesami@gmail.com</code>, указав регион, номер участка и причину запроса.</mark></p>
					</dd>

					<dt><a>Зачем всё это нужно?</a></dt>
					<dd>
						<p>Анализ волонтёров <a href="https://www.golosinfo.org/ru/articles/142771">движения Голос</a> и <a href="https://a-gabdulvaleev.livejournal.com/33076.html">наблюдателей Татарстана</a> показал, что количество избирателей, пришедших голосовать на выборах в марте 2018 года, в некоторых регионах на видео разительно отличается от того, что было опубликовано на сайтах избиркомов. Чтобы развеять или укрепить подозрения о фальсификации явки, мы предоставляем платформу, на которой добровольцы смогут проверить реальную явку на большом количестве участков.</p>
						<p>В 2012-м году мы работали над первой версией этой платформы, расположенной на сайте <a href="https://echo.msk.ru/programs/echonet/885456-echo/">schitaytesami.org</a>.</p>
					</dd>
					<dt><a>По какому принципу вы отбираете участки для разметки?</a></dt>
					<dd>Мы в полном объеме записали видео из многих регионов РФ. Некоторые регионы – это участки с «аномально» высокой явкой, но у нас также есть регионы, из которых поступало мало сообщений о нарушениях. Такие участки включены, чтобы контролировать нашу систему.</dd>
					<dt><a>Все ли участки, прошедшие разметку, публикуются в разделе результатов?</a></dt>
					<dd>Мы проверяем поступившую разметку статистическими методами, чтобы злоумышленники не внесли значимых отклонений. В частности, нам помогает то, что каждый видео-фрагмент размечается несколькими волонтерами. Все результаты на участках с разметкой, прошедшей проверку, мы публикуем.</dd>
					<dt><a>Я слышал, что современные системы компьютерного зрения могут автоматически посчитать количество голосовавших. Почему не посчитать всё автоматически?</a></dt>
					<dd>Точность существующих полностью автоматических систем, к сожалению, ограничена, и нам эти ограничения хорошо известны. Полученная разметка поможет создать автоматическую систему, адаптированную для выборных видео. Мы собираемся разработать такую систему, оценить качество её работы и обнародовать результаты.</dd>
					<dt><a>А почему и зачем видео в вашей системе играется так быстро?</a></dt>
					<dd>Мы решили не отказываться от идеи компьютерного подсчета совсем и применили алгоритмы компьютерного зрения, чтобы выявить участки видео, где кто-то подходит к урне. После этого мы обрабатываем видео, ускоренно проматывая участки, где к урне никто не подходит. Делается это только для того, чтобы сэкономить труд волонтеров. При этом иногда система всё равно замедляет видео, когда к урне никто не подходит, такие ошибки явку не искажают. Исходный код ускоряющей программы мы публикуем на нашем <a href="https://github.com/schitaytesami/tools/blob/master/speedup_video.py">GitHub</a>.</dd>
					<dt><a>А кто вы такие? Кто вас финансирует?</a></dt>
					<dd>
						<p>Мы группа российских граждан, включающая программистов, математиков, исследователей в области компьютерного зрения и специалистов по наблюдению за выборами. У нас разные политические взгляды, но мы все хотели бы, чтобы выборы в нашей стране проходили честно.</p>
						<p>На данный момент проект финансируется нами самими. Расходы на серверы значительные, поэтому будем благодарны <router-link :to="{ name: 'donate' }">финансовой помощи</router-link>.</p>
					</dd>
					<dt><a>А как еще вам помочь?</a></dt>
					<dd>Прежде всего для проекта нет ничего более ценного, чем работа волонтеров-разметчиков. Пожалуйста, разметьте несколько видео. Будет совсем здорово, если Вы расскажете о проекте друзьям, напишите и распространите пост, твит, анекдот, сагу или любое другое сообщение о нашем проекте. Мы также благодарны всем, кто выявляет ошибки или несуразности и присылает сообщения о них к нам на <code>schitaytesami@gmail.com</code> .</dd>
				</dl>
				<hr />
				<p class="mb-5">Нам помогали <a href="https://golosinfo.org">Движение «Голос»</a>, <a href="https://spbelect.org/">Наблюдатели Петербурга</a>, <a href="http://tatobservers.ru">Ассоциация наблюдателей Татарстана</a>. Выражаем благодарность <a href="https://podmoskovnik.livejournal.com/">Сергею Шпилькину</a> за предоставление данных о явке, скачанных с сайта ЦИК.</p>
			</div>
		</div>
	</script>

	<script type="text/x-template" id="app-donate">
		<div class="col-md-6 offset-md-3">
			<p>Друзья, нам очень нужна финансовая помощь. Все деньги идут на аренду техники для для хранения и обработки видео. Обещаем опубликовать отчёт о расходовании средств. </p>
			<p>Если вы готовы поддержать нас другим способом, пожалуйста, напишите нам на <code>schitaytesami@gmail.com</code> - мы обязательно ответим.</p>
			<div>
				<h4 class="text-center lead">Карта</h4>
				<div class="text-center">Номер карты Сбербанка - <strong>5336 6900 5589 7468</strong></div>
			</div>

			<div>
				<h4 class="text-center lead mt-3">Яндекс.Деньги</h4>
				<div class="text-center offset-md-3 w-50">
					<div class="payment-form mb-3">
						<form method="POST" action="https://money.yandex.ru/quickpay/confirm.xml" target="_blank">
							<input name="receiver" value="410016070927938" type="hidden">
							<input name="quickpay-form" value="shop" type="hidden">
							<input name="targets" value="Считайте Сами - на технику" type="hidden">

							<div class="form-row mb-3">
								<div class="col auto">
									<div class="payment-form__currency">
										<input class="form-control form-control-sm" id="payment-form-sum" name="sum" value="500" maxlength="10" placeholder="Р">
									</div>
								</div>

								<div class="col auto">
									<div class="payment-form__radios">
										<div class="payment-form__radio">
											<input class="" value="PC" checked="checked" id="payment-form-pc" type="radio" name="paymentType">
											<label class="payment-form__label" for="payment-form-pc">
												<i class="icon pc"></i>
											</label>
										</div>
										<div class="payment-form__radio">
											<input class="" value="AC" id="payment-form-ac" type="radio" name="paymentType">
											<label class="payment-form__label" for="payment-form-ac">
												<i class="icon ac"></i>
											</label>
										</div>
									</div>
								</div>

								<div class="row col no-gutters auto align-items-end">
									<button style="background-color: #ffdb4d;" class="btn btn-sm" type="submit" autocomplete="off" tabindex="0">Пожертвовать</button>
								</div>
							</div>

						</form>
					</div>
				</div>
			</div>

			<div>
				<h4 class="text-center lead">PayPal</h4>
				<div class="text-center">
					<a
						class="btn btn-outline-primary"
						href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=DVPJUN8Y5R4K2"
						><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJYAAAAmCAYAAAAmy2KXAAAFRmlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS41LWMwMTIgMS4xNDk2MDIsIDIwMTIvMTAvMTAtMTg6MTA6MjQgICAgICAgICI+CiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iCiAgICB4bWxuczpkYW09Imh0dHA6Ly93d3cuZGF5LmNvbS9kYW0vMS4wIgogICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iCiAgICB4bWxuczpQYXlQYWw9Ind3dy5wYXlwYWwuY29tL2Jhc2UvdjEiCiAgIGRjOmZvcm1hdD0iaW1hZ2UvcG5nIgogICBkYzptb2RpZmllZD0iMjAxNC0wNy0yM1QxMzozNTo1My44NS0wNzowMCIKICAgZGFtOnNpemU9IjIxMjIiCiAgIGRhbTpQaHlzaWNhbHdpZHRoaW5pbmNoZXM9Ii0xLjAiCiAgIGRhbTpleHRyYWN0ZWQ9IjIwMTQtMDctMjNUMTM6MzU6NTAuMjMzLTA3OjAwIgogICBkYW06c2hhMT0iMDk4Zjg4NDU5MDk1MTZmNjljZGEzNDllNGMxZTBlYjQxOTMzYmQ0YiIKICAgZGFtOk51bWJlcm9mdGV4dHVhbGNvbW1lbnRzPSIwIgogICBkYW06RmlsZWZvcm1hdD0iUE5HIgogICBkYW06UHJvZ3Jlc3NpdmU9Im5vIgogICBkYW06UGh5c2ljYWxoZWlnaHRpbmRwaT0iLTEiCiAgIGRhbTpNSU1FdHlwZT0iaW1hZ2UvcG5nIgogICBkYW06TnVtYmVyb2ZpbWFnZXM9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" alt="PayPal" style="height: 1.2rem; margin: 0 0.3rem 0.3rem;"/>Пожертвовать</a><!-- src="https://www.paypalobjects.com/webstatic/en_US/i/buttons/PP_logo_h_150x38.png" -->
				</div>
			</div>
			<hr/>
			<p class="text-center">Карта Сбербанка и счёт Яндекс.Деньги принадлежат <a href="http://tatobservers.ru/author/azat/">Азату Габдульвалееву</a>, нашему доверенному лицу и наблюдателю в Татарстане.</p>
		</div>
	</script>

	<script type="text/x-template" id="app-error">
		<div class="alert alert-danger" role="alert" v-if="showError">
			<div class="container">
				<div class="row">
					<div class="col text-center">
						<strong>Произошла ошибка!</strong> <slot></slot>. Обновите страницу или сообщите об ошибке нам на <code>schitaytesami@gmail.com</code>.</a>
					</div>
				</div>
			</div>
		</div>
	</script>

	<script type="text/x-template" id="app-selection">
		<form>
			<div class="form-group row">
				<div class="col-md-6 mb-3 mb-md-0">
					<select id="election" class="form-control form-control-sm" v-model="election_number">
						<option v-for="[ n, v ] in election_list" :value="v" :disabled="v === 'disabled'">{{ n }}</option>
					</select>
				</div>
				<div class="col-md-6">
					<input type="text" class="form-control form-control-sm" placeholder="Фильтр" v-model="election_filter">
				</div>
			</div>
			<div class="form-group row">
				<div class="col-md-6 mb-3 mb-md-0">
					<select id="region" class="form-control form-control-sm"v-model="region_number">
						<option v-for="[ n, v ] in region_list" :value="v" :disabled="v === 'disabled'">{{ n }}</option>
					</select>
				</div>
				<div class="col-md-6">
					<input type="text" class="form-control form-control-sm" placeholder="Фильтр" v-model="region_filter">
				</div>
			</div>
			<div class="form-group row">
				<div class="col-md-6 mb-3 mb-md-0">
					<select id="station" class="form-control form-control-sm" v-model="station_number">
						<option v-for="[ n, v ] in station_list" :value="v" :disabled="v === 'disabled'">{{ n }}</option>
					</select>
				</div>
				<div class="col-md-6">
					<input type="text" class="form-control form-control-sm" placeholder="Фильтр" v-model="station_filter">
				</div>
			</div>
			<slot
				:election_number="election_number"
				:region_number="region_number"
				:station_number="station_number"
			></slot>
		</form>
	</script>

	<script type="text/x-template" id="app-bookmark-button">
		<button
			type="button"
			class="btn"
			:class="{ 'btn-success': submitted, 'btn-primary' : !submitted }"
			:disabled="submitted"
			@click="submit"
		>{{ submitted ? 'Добавлено' : 'Добавить в закладки' }}</button>
	</script>

	<script type="text/x-template" id="app-access-button">
		<button
			class="btn btn-sm" :class="{ 'btn-success': granted, 'btn-light': !granted }"
			:disabled="granted !== -1"
			@click="submit"
		>{{ formatAccessButtonText(granted) }}</button>
	</script>

	<script src="https://unpkg.com/vue@2.5.17/dist/vue.min.js"></script>
	<script src="https://unpkg.com/vue-router@3.0.1/dist/vue-router.min.js"></script>

	<script type="text/javascript">

		(function () {
			const makeError = err => {
				const status = err.status ? `${err.status}: ` : '';
				const message = err.statusText || 'Что-то пошло не так';
				return new Error(`${status}${message}`);
			};

			async function fetchStats() {
				const response = await fetch('/stats');
				if (!response.ok) throw makeError(response);

				let data;
				try {
					data = await response.json();
				} catch (err) {
					throw new Error(err);
				}

				const stats = {
						...data,
						clips_dict: {},
						stations_dict: {},
						stations_dict_station_id: {},
					};

				data.clips.forEach(clip => {
					stats.clips_dict[clip.id] = clip;
				});
				data.stations.forEach(station => {
					stats.stations_dict[station.id] = station;
					stats.stations_dict_station_id[station.station_id] = station;
				});

				stats.bookmarks_dict = stats.bookmarks.reduce((acc, event) => ({
					[event.id]: {...stats.stations_dict[event.station_id], ...event},
					...acc,
				}), {});

				stats.notes_dict = stats.notes.reduce((acc, event) => ({
					[event.id]: {...stats.stations_dict[event.station_id], ...event},
					...acc,
				}), {});

			  stats.formatStationIdFull = station_id => stats.stations_dict[station_id].station_id;

			  return stats;
			}

			const statsPromise = fetchStats();

			async function sendEvents(events, { id, csrf }) {
				const response = await fetch(`/events/${id}?csrf=${csrf}`, {
					method: 'post',
					headers: {'Content-type': 'application/json'},
					body: JSON.stringify(events),
				});
				if (!response.ok) throw makeError(response);

				return response;
			}

			async function nextTask({ task, election_number, region_number, station_number }) {
				const response = await
					fetch(`/task/${task}/election/${election_number}/region/${region_number}/station/${station_number}`);
				if (!response.ok) throw makeError(response);

				try {
					return await response.json();
				} catch (err) {
					throw new Error(err);
				}
			}

			async function sendAccess({ user_id, station_id }) {
				const response = await fetch(`/user/${user_id}/access/station/${station_id}`, {
					method: 'POST',
					headers: {'Content-type': 'application/json'},
				});
				if (!response.ok) throw makeError(response);

				return response;
			}

			const initVue = () => {
				const formatHoursMinutes = (timestamp, timezoneOffset) => {
					if (!timestamp)
						return '';
					const time = new Date(1000 * (timestamp + timezoneOffset * 60));
					const hours = time.getUTCHours(), minutes = time.getUTCMinutes();
					return `${hours}:${minutes < 10 ? "0" : "" }${minutes}`;
				};

				const formatHours = seconds => seconds ? (seconds / 3600).toFixed(0) : 0;

				const formatMinutes = seconds => (seconds / 60).toFixed(0);

				const formatTimestamp = timestamp => new Date(timestamp * 1000).toLocaleString('ru-RU');

				const formatElectionDate = election_number => {
					const date = String(election_number);
					return date ? `${date.substr(6)}/${date.substr(4, 2)}/${date.substr(0, 4)}` : '';
				};

				const formatClipInterval = (clip, station, full) => (full == true ? formatElectionDate(station.election_number) + ', ' : '') + `${formatHoursMinutes(clip.clip_interval_start, station.timezone_offset)} - ${formatHoursMinutes(clip.clip_interval_end, station.timezone_offset)}`;

				const formatRegionName = station_address => station_address.split(',')[0];

				const formatThumbnailTitle = (station, clip) =>
					`${formatRegionName(station.station_address)}, ${formatElectionDate(station.election_number)}, УИК ${station.station_number}`+
					(typeof(clip) === 'number' ?
						`, Сегментов: ${clip}.` :
						` ${formatHoursMinutes(clip.clip_interval_start, station.timezone_offset)}-${formatHoursMinutes(clip.clip_interval_end, station.timezone_offset)}`);

				const formatPercent = fraction => `${(fraction * 100).toFixed(0)}%`;

				const sorterNewFirst = (a, b) => b.timestamp - a.timestamp;

				const appIndex = {
					methods : {formatHours : formatHours, formatThumbnailTitle : formatThumbnailTitle},
					computed: {
						guard() { return this.$root.stats.stations && !this.$root.showError; },
						thumbnails() {
							return Array(Math.min(this.$root.stats.clips.length, 5)).fill().map(_ =>
							{
								const id = Math.floor(Math.random() * this.$root.stats.clips.length);
								const clip = this.$root.stats.clips_dict[id];
								const station = this.$root.stats.stations_dict[clip.station_id];
								return { clip, station };
							});
						},
					},
					template: '#app-index',
				};

				const appTask = {
					data() {
						return {
							email: '',
							registered: false,
						}
					},
					methods : {
						async register() {
							try {
								this.registered = await this.$root.register(this.email);
							} catch (err) {
								this.$root.errorHandler(err);
							}
						},
					},
					template: '#app-task'
				};

				const appTaskBase = {
					props: {
						are_controls_vote_shown: {
							type: Boolean,
							required: true,
						},
						are_controls_proc_shown: {
							type: Boolean,
							required: true,
						},
					},
					data() {
						return {
							questions : [
								{yes_no : '', comment : '', question_text : 'Подсчет и погашение неиспользованных бюллетеней началось сразу после окончания голосования и проводилось <strong>до подсчета</strong> по спискам избирателей' },
								{yes_no : '', comment : '', question_text : 'Число погашенных бюллетеней было <strong>внесено в УФП</strong> сразу после подсчета, перед подсчетом по списку избирателей' },
								{yes_no : '', comment : '', question_text : 'Данные подсчета по списку избирателей были <strong>оглашены</strong> и <strong>занесены</strong> в УФП <strong>до</strong> вскрытия переносных ящиков' },
								{yes_no : '', comment : '', question_text : 'Был произведен отдельный подсчет числа бюллетеней из переносных ящиков, это число записано в УФП до вскрытия стационарных ящиков' },
								{yes_no : '', comment : '', question_text : 'Сортировка бюллетеней производилась путем предъявления бюллетеней и оглашения отметки в нем' },
								{yes_no : '', comment : '', question_text : 'Подсчет бюллетеней в рассортированных пачках производился поочередно по пачкам и путем перекладывания бюллетеней' },
								{yes_no : '', comment : '', question_text : 'Всем желающим была обеспечена возможность видеть отметки в бюллетенях' },
								{yes_no : '', comment : '', question_text : 'Данные подсчета по рассортированным пачкам были сразу внесены в УФП' },
								{yes_no : '', comment : '', question_text : 'Бюллетени кандидатов были упакованы в отдельные пачки' },
								{yes_no : '', comment : '', question_text : 'Состоялось итоговое заседание УИК' },
								{yes_no : '', comment : '', question_text : 'Протокол об итогах голосования был предъявлен в одну из видеокамер, все данные из протокола были оглашены' },
								{hide_yes_no : true, yes_no : '', comment : '', question_text : 'Попадают ли в зону видимости видеокамер все установленные инструкцией объекты (столы подсчета, УФП и пр. -см. Инструкцию)' },
								{hide_yes_no : true, yes_no : '', comment : '', question_text : 'Оцените качество аудиозаписи (хорошо ли различимо оглашение данных, не было ли помех для аудиозаписи)' },
								{hide_yes_no : true, yes_no : '', comment : '', question_text : 'Замеченные нарушения, не отраженные выше' },
							],
							showInstruction: false,
							showEvents: true,
							clip: null,
							events: [],
							note: '',
							started: false,
							completed: false,
							submitted: false,
							failed: false,
						};
					},
					computed: {
						user() {
							return this.$root.user;
						},
					},
					methods: {
						formatInstructionToggleText : showInstruction => showInstruction ? 'Убрать инструкцию ▼' : 'Показать инструкцию ▲',
						formatTaskSubmitResultsButtonText(submitted, failed) {
							let message = 'Разметка этого видео закончена. Спасибо!';
							let button = 'Отправить результаты';

							if (submitted)
								button = 'Перейти к разметке следующего видео';

							if (failed) {
								message = 'При отправке результатов возникла ошибка!';
								button = 'Отправить результаты снова';
							}

							return { message, button };
						},
						formatEventTime(offset) {
							const minutes = Math.floor(offset / 60);
							let seconds = Math.floor(offset % 60);
							if (seconds < 10) seconds = `0${seconds}`;
							return `${minutes}:${seconds}`;
						},
						async submitResults() {
							const events = this.$route.name == 'vote' ?
								this.events :
								this.$route.name == 'proc' ?
									this.questions.map((q, i) => ({
										offset: 0,
										clip: this.clip.id,
										type : `question${i}`,
										value : JSON.stringify(q),
									})) : [];

							if (!this.submitted && (this.failed || this.completed))
								await this.sendEvents(events);
							else
								await this.nextTask();
						},
						async sendEvents(events) {
							try {
								await sendEvents(events, {
									id: this.clip.id,
									csrf: this.clip.csrf,
								});
								this.submitted = true;
								this.failed = false;
							} catch (err) {
								this.failed = true;
								this.$root.errorHandler(err);
							}
						},
						async nextTask() {
							try {
								const clip = await nextTask({
									task: this.$route.name,
									...this.$route.params,
								});
								this.clip = clip;
								this.events = [];
								this.submitted = false;
								this.completed = false;
								this.failed = false;
							} catch (err) {
								this.$root.errorHandler(err);
							}
						},
						addEvent(offset, type, value = '') {
							this.events.unshift({ offset: Math.floor(offset), clip: this.clip.id, value, type });
							if (value) this.note = '';
						},
						removeEvent(event) {
							this.events.splice(this.events.indexOf(event), 1);
						},
						keyDown(e) {
							if (this.$route.name == 'vote' && this.$refs.note !== document.activeElement) {
								const keycode_space = 32;
								const keycode_escape = 27;

								if (e.keyCode == keycode_space) {
									e.preventDefault();
									this.addEvent(this.$refs.player.currentTime, 'vote');
								} else if (e.keyCode == keycode_escape) {
									e.preventDefault();
									this.$refs.player.pause();
								}
							}
						},
					},
					created() {
						document.removeEventListener('keydown', this.keyDown);
						document.addEventListener('keydown', this.keyDown);

						this.nextTask();
					},
					template: '#app-task-base',
				};

				const appTaskVote = {
					name: 'app-task-vote',
					components: {
						'app-task-base': appTaskBase,
					},
					template: '#app-task-vote',
				};

				const appTaskProc = {
					name: 'app-task-proc',
					components: {
						'app-task-base': appTaskBase,
					},
					template: '#app-task-proc',
				};

				const appClipPlayer = {
					props: {
						clip: {
							type: Object,
							required: true,
						},
						verbose: {
							type: Boolean,
							required: true,
						},
						started: {
							type: Boolean,
							required: false,
						},
						completed: {
							type: Boolean,
							required: false,
						},
					},
					name : 'app-clip-player',
					template : '#app-clip-player',
					data() {
						return {
							playbackRate : 1.0,
							currentTime: 0,
						};
					},
					computed: {
						station() {
							if (this.$root.stats && this.$root.stats.clips_dict) {
								const { station_id } = this.$root.stats.clips_dict[this.clip.id];
								const station = this.$root.stats.stations_dict[station_id];
								return station;
							}

							return {};
						},
					},
					methods : {
						formatTimezoneOffset : timezone_offset => (timezone_offset / 60.0).toFixed(1).replace('.0', ''),
						formatClipInterval : formatClipInterval,
						formatRegionName : formatRegionName,
						pause() {
							this.$refs.player.pause();
						},
						setPlaybackRate(delta) {
							this.$refs.player.playbackRate = Math.max(this.$refs.player.playbackRate + delta, 0.5);
							this.playbackRate = this.$refs.player.playbackRate;
						},
					},
				};

				const appStation = {
					turnoutOrder: ['final', '10h', '12h', '15h', '18h'],
					name: 'app-station',
					data() {
						return {
							current_clip: null,
						};
					},
					computed: {
						station() {
							return this.$root.stats.stations_dict_station_id
								? this.$root.stats.stations_dict_station_id[this.$route.params.id]
								: {};
						},
						clips() {
							if (this.station.clips) {
								const clips = this.station.clips.split(',').map(clip_id => this.$root.stats.clips_dict[Number(clip_id)]);
								if (this.current_clip === null) this.current_clip = clips[0];
								return clips;
							}

							return [];
						},
						notes() {
							if (!this.$root.user) return [];

							const user = (this.$root.stats.users || []).find(u => u.id === this.$root.user.id);
							const user_access = (this.$root.stats.station_access || [])
								.find(x => x.station_id === this.station.id && x.user_id === user.id) || {};

							if (user_access.granted === 1)
								return (this.$root.stats.notes || [])
									.filter(note => note.station_id === this.station.id)
									.map(note => this.$root.stats.notes_dict[note.id])

							const user_notes = (!user || !user.notes) ? [] : user.notes
								.split(',')
								.map(id => this.$root.stats.notes_dict[id])
								.filter(note => note.station_id === this.station.id);

							return user_notes;
						},
						segments() {
							const num_columns = 4;
							const chunk = Math.ceil(this.clips.length / num_columns);
							return Array(num_columns).fill().map((_, k) => this.clips.slice(k * chunk, (k + 1) * chunk));
						},
						tasks() {
							const clips = this.clips;
							const camera_ids = Array.from(new Set(clips.map(c => c.camera_id))).sort();
							const task_types = Array.from(new Set(clips.map(c => c.task))).sort();
							const fromEntries = arr => Object.assign({}, ...Array.from(arr, ([k, v]) => ({[k]: v}) ));
							return {
								camera_ids: camera_ids,
								tasks: task_types.map(task_type => {
									const camera_id2clips = camera_ids.map(camera_id =>
										[camera_id, clips.filter(c => c.task == task_type && c.camera_id == camera_id)]);

									return {
										task : task_type,
										max_num_clips : Math.max(...camera_id2clips.map(c => c[1].length)),
										clips : fromEntries(camera_id2clips),
									};
								}),
							};
						}
					},
					methods: {
						formatClipTask : clip_task => ({ full : 'Полное видео', vote : 'Контроль явки', proc : 'Процедура подсчёта голосов' })[clip_task] || clip_task,
						formatClipInterval : formatClipInterval,
						getTurnout(name) {
							if (!this.station.turnout) return {};
							const obj = this.station.turnout[name];
							const orderList = this.$options.turnoutOrder;
							return !obj ? [] : Object.keys(obj).reduce((acc, cur) => (orderList.includes(cur) && (acc[orderList.indexOf(cur)] = obj[cur]), acc), []);
						},
					},
					template: '#app-station',
				};

				const appUser = {
					name: 'app-user',
					methods : {formatElectionDate : formatElectionDate, formatRegionName : formatRegionName, formatTimestamp : formatTimestamp},
					computed: {
						user() {
							return this.$root.stats.users.find(u => u.display === this.$route.params.display);
						},
						thumbnails() {
							const clipsByStation = this.user.clips.split(',').map(Number).reduce((acc, clip_id) => {
								const clip = this.$root.stats.clips_dict[clip_id];
								const station = this.$root.stats.stations_dict[clip.station_id];
								acc[clip.station_id] = acc[clip.station_id] || [];
								acc[clip.station_id].push(clip);
								return acc;
							}, {});

							return Object.keys(clipsByStation).map(id => ({
									id : this.$root.stats.stations_dict[id].station_id,
									src: clipsByStation[id][0].thumbnail,
									title: formatThumbnailTitle(this.$root.stats.stations_dict[id], clipsByStation[id].length)
								})
							);
						},
						bookmarks() {
							return this.user.bookmarks
								.split(',')
								.filter(Boolean)
								.map(id => this.$root.stats.bookmarks_dict[id])
								.sort(sorterNewFirst);
						},
						notes() {
							return this.user.notes
								.split(',')
								.filter(Boolean)
								.map(id => this.$root.stats.notes_dict[id]);
						},
						station_access() {
							return this.$root.stats.station_access
								.filter(x => x.user_id === this.user.id)
								.sort(sorterNewFirst)
								.map(station_access => ({
									...station_access,
									...this.$root.stats.stations_dict[station_access.station_id]
							}));
						},
					},
					async beforeRouteEnter(to, from, next) {
						await statsPromise;
						next();
					},
					template: '#app-user'
				};

				const appSelection = {
					name: 'app-selection',
					props: {
						options: {
							type: Array,
							required: true,
						},
					},
					data() {
						return {
							/* the options prop must contain the value for election_number */
							election_number: this.options[0][1],
							region_number: this.options[0][2][0][1],
							station_number: this.options[0][2][0][2][0][1],
							election_filter: '',
							region_filter: '',
							station_filter: '',
						};
					},
					computed: {
						election_list() { return this.filter(this.options, 'election');	},
						region_list() {	return this.filter(this.getList([this.election_number]), 'region'); },
						station_list() { return this.filter(this.getList([this.election_number, this.region_number]), 'station'); }
					},
					methods: {
						filter(list, value) {
							const filtered_special = list.filter(opt => opt[1] < 0);
							const filtered = list.filter(opt =>
								opt[1] >= 0 &&
								String(opt[0]).toLowerCase().includes(this[value + '_filter'].toLowerCase())
							);

							if (filtered_special.length > 0 && filtered.length > 0)
								filtered_special.push(['━━━━━━━━━━━━', 'disabled']);

							if (this[value + '_filter'] !== '')
								this[value + '_number'] = filtered.length > 0 ?
									filtered[0][1] :
									filtered_special.length > 0 ?
									filtered_special[0][1] :
									list[0][1];

							return filtered_special.length + filtered.length > 0 ?
								filtered_special.concat(filtered) :
								list;
						},
						getList(values) {
							return values.reduce((list, value) =>
								list.find(opt => opt[1] === value)[2], this.options);
						},
					},
					watch: {
						/* reset the subselects not only visually but also in data */
						election_number() {
							this.region_number = this.getList([this.election_number])[0][1];
						},
						region_number() {
							this.station_number = this.getList([this.election_number, this.region_number])[0][1];
						},
					},
					template: '#app-selection',
				};

				const appBookmarkButton = {
					name: 'bookmark-button',
					props: {
						clip: {
							type: Object,
							required: true,
						},
					},
					data() {
						return {
							submitted: false,
							failed: false,
						};
					},
					methods: {
						async submit() {
							const event = {
								type: 'bookmark',
								offset: 0,
								value: window.location.href,
								clip: this.clip.id,
							};

							try {
								await sendEvents([event], {
									id: this.clip.id,
									csrf: this.clip.csrf,
								});
								this.submitted = true;
								this.failed = false;
							} catch (err) {
								this.failed = true;
								this.$root.errorHandler(err);
							}
						},
				  },
				  template: '#app-bookmark-button',
				};

				const appAccessButton = {
				  name: 'access-button',
				  props: ['station_id', 'user_id'],
				  data() {
						return {
							granted: -2,
						};
					},
					computed: {
						// When the component is mounted probably there is no this.$root.stats.station_access
						station_access() {
							return this.$root.stats.station_access;
						},
					},
					methods: {
						formatAccessButtonText: granted => ({
							'1': 'Доступ разрешен',
							'0': 'Доступ запрошен',
							'-1': 'Запросить доступ',
						})[granted] || 'Загрузка...',
						async submit() {
							try {
								const { user_id, station_id } = this;
								await sendAccess({ user_id, station_id });
								this.granted = 0;
							} catch (err) {
								this.$root.errorHandler(err);
							}
						},
						set_state() {
							if (this.station_access == null) {
								this.granted = -2;
								return;
							}

							this.granted = this.$root.checkStationAccess(this.station_id);
						}
					},
					watch: {
						// the watcher is good for async op like getting $root.stats
						// we use this if stats is NOT loaded
						station_access() {
							this.set_state();
						},
					},
					// we use this if stats is loaded
					mounted() {
						this.set_state();
					},
					template: '#app-access-button',
				};

				const appUsers = {
					methods : {formatMinutes : formatMinutes},
					template: '#app-users',
				};

				const appStations = {
					methods : {formatElectionDate : formatElectionDate, formatRegionName : formatRegionName, formatPercent : formatPercent},
					template: '#app-stations',
				};

				const appNotes = {
					methods: {formatElectionDate : formatElectionDate, formatRegionName : formatRegionName, formatTimestamp : formatTimestamp, sorter : sorterNewFirst},
					props: ['notes'],
					template: '#app-notes',
				};

				const router = new VueRouter({
					linkActiveClass: 'active',
					routes: [
						{ path: '/', name: 'index', component: appIndex },
						{ path: '/task', name: 'task', component: appTask },
						{
							path: '/task/vote/election/:election_number/region/:region_number/station/:station_number',
							name: 'vote',
							component: appTaskVote,
						},
						{
							path: '/task/proc/election/:election_number/region/:region_number/station/:station_number',
							name: 'proc',
							component: appTaskProc,
						},
						{ path: '/stations', name: 'stations', component: appStations },
						{ path: '/stations/:id', name: 'station', component: appStation },
						{ path: '/users', name: 'users', component: appUsers },
						{ path: '/user/:display', name: 'user', component: appUser },
						{ path: '/about', name: 'about', component: { template: '#app-about' } },
						{ path: '/donate', name: 'donate', component: { template: '#app-donate' } },
						{
							path: '/login/:token',
							component: {
								render(c) {
									return c();
								},
								beforeRouteEnter(to, from, next) {
									next(
										vm => (vm.$root.login(vm.$route.params.token), vm.$router.push({ name: 'index' }))
									);
								},
							},
						},
					],
				});

				Vue.component('app-selection', appSelection);
				Vue.component('app-bookmark-button', appBookmarkButton);
				Vue.component('app-access-button', appAccessButton);
				Vue.component('app-notes', appNotes);
				Vue.component('app-clip-player', appClipPlayer);

				const app = new Vue({
					el: '#app',
					router,
					data: {
						stats: {},
						user: null,
						showError: false,
						errorMessage: '',
					},
					methods: {
						errorHandler(err) {
							this.showError = true;
							this.errorMessage = err.message;
						},
						login(token) {
							const userToken = token != null ? token : (document.cookie.match(/user_token=([^;^$]+)/) || [, ''])[1];
							this.user = userToken ? { ...JSON.parse(atob(userToken)), is_admin : function() { return this.role.includes('admin'); } } : null;
							document.cookie = 'user_token=' + userToken + ';';
						},
						logout() {
							this.login('');
							this.$router.push({ name: 'index' });
							window.location.reload();
						},
						async register(email) {
							const response = await fetch('/user', {
								method: 'post',
								headers: { 'Content-type': 'text/plain' },
								body: email,
							});

							if (!response.ok) throw makeError(response);

							return true;
						},
						checkStationAccess(station_id) {
							const { station_access } = this.stats;

							if (station_access == null || this.user === null) return -1;

							const user_access =	station_access.find(sa =>
								sa.station_id === station_id && sa.user_id === this.user.id);

							if (user_access == null) return -1;

							return user_access.granted;
						},
					},
					components: {
						'app-navigation-menu': {
							template: '#app-navigation-menu',
							props: ['logout'],
						},
						'app-error' : {
							template: '#app-error',
							props: ['showError']
						}
					},
					beforeMount() {
						if(!this.user) this.login();

						statsPromise
							.then(stats => {
								this.stats = {
									...this.stats,
									...stats,
								};
							})
							.catch(this.errorHandler);
					},
					render(c) {
						return c('div', [
							c('app-navigation-menu', { props: { logout: this.logout } }),
							c('app-error', { props: { showError: this.showError } }, this.errorMessage),
							c(
								'main',
								{
									attrs: {
										role: 'main',
										class: 'container-fluid tab-content mt-2',
									},
								},
								[
									c('keep-alive', { props: { exclude: ['app-station', 'app-user', 'app-task-vote', 'app-task-proc'] } }, [
										c('router-view', { on: { error: this.errorHandler } }),
									]),
								]
							),
						]);
					},
				});

				return app;
			};

			document.addEventListener('DOMContentLoaded', initVue);
		}());
	</script>
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-125315998-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());
		gtag('config', 'UA-125315998-1');
	</script>
</body>

</html>
